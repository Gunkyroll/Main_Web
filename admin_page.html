<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin: Order Status</title>
  <!-- Bootstrap CSS (integrity updated) -->
  <link 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" 
    rel="stylesheet" 
    integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" 
    crossorigin="anonymous"
  >
</head>
<body class="p-4">
  <h1>Order Status Dashboard</h1>
  <div id="login-container" class="mb-4"></div>
  <div id="admin-ui" style="display:none;">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Order ID</th><th>Payment</th><th>Order</th><th>Delivery</th><th>Age</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="status-table-body"></tbody>
    </table>
  </div>

  <!-- Supabase UMD -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Expose client globally for renderLogin, loadStatuses, saveRow
    let supabaseClient;

    document.addEventListener('DOMContentLoaded', () => {
      // Initialize the client using the UMD global supabaseJs
    const SUPABASE_URL     = 'https://xtpxpoiwukeufdngxrow.supabase.co';
    const SUPABASE_ANON_KEY= 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh0cHhwb2l3dWtldWZkbmd4cm93Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc2MDc0NDAsImV4cCI6MjA2MzE4MzQ0MH0.0pkLuu73EkiDd6A4BvNZdz1nl0HZVqtDWp_NZRp4AoA';

      supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // 1) Try to read existing session
    supabaseClient.auth.getSession().then(({ data: { session } }) => {
      handleSession(session);
    });


      function handleSession(session) {
    if (session?.user?.app_metadata?.role === 'admin') {
      // show your admin UI
      loadStatuses();
    } else {
      // redirect or show login
      window.location.href = '/login_signup.html';
    }
  }

      // 1) Watch for auth changes
      supabaseClient.auth.onAuthStateChange((event, session) => {
        console.log('[Auth] event:', event, 'session:', session);
        handleAuth(session);
      });

      // 2) Check existing session
      supabaseClient.auth.getSession()
        .then(({ data: { session } }) => {
          console.log('[Auth] initial session:', session);
          handleAuth(session);
        })
        .catch(err => console.error('getSession error', err));
    });

    function handleAuth(session) {
      const isAdmin = session?.user?.app_metadata?.role === 'admin';
      console.log('[Auth] isAdmin?', isAdmin);
      document.getElementById('login-container').style.display = isAdmin ? 'none' : 'block';
      document.getElementById('admin-ui').style.display      = isAdmin ? 'block': 'none';
      if (isAdmin) {
        loadStatuses();
      } else {
        renderLogin();
      }
    }

    function renderLogin() {
      const container = document.getElementById('login-container');
      container.innerHTML = '<button id="btn-login" class="btn btn-primary">Sign In with GitHub</button>';
      document.getElementById('btn-login').onclick = () => supabaseClient.auth.signInWithOAuth({ provider: 'github' });
    }

    async function loadStatuses() {
      console.log('[loadStatuses] fetching order_status…');
      const res = await supabaseClient
        .from('order_status')
        .select('*')
        .order('created_at', { ascending: false });
      console.log('[loadStatuses] response:', res);
      const { data, error } = res;
      if (error) {
        console.error('Failed to load statuses:', error);
        return alert('Failed to load statuses – see console.');
      }
      if (!data || data.length === 0) {
        console.warn('No order_status rows returned');
      }
      const tbody = document.getElementById('status-table-body');
      tbody.innerHTML = data.map(r => `
        <tr>
          <td>${r.order_id}</td>
          <td><input type="text" class="form-control form-control-sm" data-id="${r.id}" data-col="payment_status" value="${r.payment_status}"></td>
          <td><input type="text" class="form-control form-control-sm" data-id="${r.id}" data-col="order_status" value="${r.order_status}"></td>
          <td><input type="text" class="form-control form-control-sm" data-id="${r.id}" data-col="delivery_status" value="${r.delivery_status}"></td>
          <td><input type="text" class="form-control form-control-sm" data-id="${r.id}" data-col="age_status" value="${r.age_status}"></td>
          <td><button class="btn btn-sm btn-success btn-save" data-id="${r.id}">Save</button></td>
        </tr>
      `).join('');
      document.querySelectorAll('.btn-save').forEach(btn => btn.onclick = saveRow);
    }

    async function saveRow(e) {
      const id = e.target.dataset.id;
      const row = e.target.closest('tr');
      const updates = {};
      row.querySelectorAll('input[data-col]').forEach(input => {
        updates[input.dataset.col] = input.value;
      });
      console.log('[saveRow] updates for', id, updates);
      const { error } = await supabaseClient
        .from('order_status')
        .update(updates)
        .eq('id', id);
      if (error) alert('Update failed: ' + error.message);
      else alert('Status updated');
    }  
    </script>
</body>
</html>
